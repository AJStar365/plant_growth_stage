{% extends 'base.html' %}

{% block title %}Dashboard - Plant Growth Detector{% endblock %}

{% block content %}
<div class="row mb-4">
  <div class="col-12">
    <h2 class="text-success">Dashboard</h2>
    <p class="text-muted">Welcome back, {{ user.username }}! Here's your activity overview.</p>
  </div>
</div>

<div class="row mb-5">
  <div class="col-md-6">
    <div class="card shadow-sm rounded-4 h-100">
      <div class="card-body">
        <h5 class="card-title mb-4">Predictions Overview</h5>
        <canvas id="predictionsChart"></canvas>
      </div>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card shadow-sm rounded-4 h-100">
      <div class="card-body d-flex flex-column justify-content-center align-items-center text-center">
        <h1 class="display-1 fw-bold text-success">{{ predictions.count }}</h1>
        <p class="lead text-muted">Total Predictions</p>
      </div>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-12">
    <div class="card shadow-sm rounded-4">
      <div class="card-body">
        <h5 class="card-title mb-3">Recent History</h5>
        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead class="table-light">
              <tr>
                <th>Image</th>
                <th>Prediction</th>
                <th>Confidence</th>
                <th>Date</th>
              </tr>
            </thead>
            <tbody>
              {% for prediction in predictions %}
              <tr>
                <td>
                  {% if prediction.image %}
                    <img src="{{ prediction.image.url }}" alt="Plant" class="rounded" style="width: 50px; height: 50px; object-fit: cover;">
                  {% else %}
                    <span class="text-muted">No Image</span>
                  {% endif %}
                </td>
                <td><span class="badge bg-success rounded-pill">{{ prediction.predicted_stage }}</span></td>
                <td>
                  {% if prediction.confidence %}
                    {{ prediction.confidence|floatformat:2 }}
                  {% else %}
                    N/A
                  {% endif %}
                </td>
                <td>{{ prediction.created_at|date:"M d, Y H:i" }}</td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="4" class="text-center text-muted py-4">No predictions yet. Go make some!</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('predictionsChart').getContext('2d');
    
    // Data from Django view
    const chartLabels = JSON.parse('{{ chart_labels|escapejs }}');
    const chartData = JSON.parse('{{ chart_data|escapejs }}');

    if (chartLabels.length > 0) {
        new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: chartLabels,
            datasets: [{
            data: chartData,
            backgroundColor: [
                '#2e7d32', // Dark Green
                '#4caf50', // Green
                '#81c784', // Light Green
                '#a5d6a7', // Lighter Green
                '#c8e6c9', // Pale Green
                '#e8f5e9'  // Very Pale Green
            ],
            borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            plugins: {
            legend: {
                position: 'right',
            }
            }
        }
        });
    } else {
        // Handle empty data case
        ctx.font = "16px Arial";
        ctx.fillText("No data to display", 10, 50);
    }
  });
</script>
{% endblock %}
